<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BMS Log Visualizer - Professional Edition</title>

  <meta name="description" content="Upload your BMS YAML logs and visualize voltage, current, SOC, energy, and cell-level metrics." />
  <meta name="theme-color" content="#3b82f6" />

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/responsive.css" />
  <link rel="stylesheet" href="css/animations.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script src="js/config.js" defer></script>
  <script src="js/utils.js" defer></script>
  <script src="js/parser.js" defer></script>
  <script src="js/calculations.js" defer></script>
  <script src="js/charts.js" defer></script>
  <script src="js/app.js" defer></script>
</head>

<body>
  <a class="skip-to-content" href="#main">Skip to main content</a>

  <div class="container" id="main" role="main">
    <header class="header">
      <h1>âš¡ BMS Log Visualizer</h1>
      <div class="subtitle">
        Professional Battery Management System Analytics with 16-Cell Monitoring
      </div>
    </header>

    <section class="upload-section" aria-labelledby="upload-heading">
      <h2 id="upload-heading" class="sr-only">File Upload</h2>
      
      <div class="file-input-wrapper">
        <input 
          id="fileInput" 
          type="file" 
          accept=".yaml,.yml,.txt" 
          aria-describedby="fileName"
        />
        <label for="fileInput" class="file-label">
          <span aria-hidden="true">ğŸ“‚</span> Choose BMS Log File
        </label>
      </div>
      <div id="fileName" class="file-name" role="status" aria-live="polite">
        No file selected
      </div>

      <div class="controls" role="toolbar" aria-label="Data controls">
        <button 
          id="absoluteTimeBtn" 
          class="control-btn active" 
          aria-pressed="true"
          title="Show absolute timestamps"
        >
          ğŸ• Absolute Time
        </button>
        <button 
          id="relativeTimeBtn" 
          class="control-btn" 
          aria-pressed="false"
          title="Show time relative to start"
        >
          â±ï¸ Relative Time
        </button>
        <button 
          id="smoothingBtn" 
          class="control-btn" 
          aria-pressed="false"
          title="Apply data smoothing filter"
        >
          ğŸ“Š Smoothing: Off
        </button>
        <button 
          id="clearBtn" 
          class="control-btn" 
          title="Clear all data and reset"
        >
          ğŸ—‘ï¸ Clear
        </button>
        <button 
          id="exportBtn" 
          class="control-btn" 
          title="Export main metrics to CSV"
        >
          ğŸ’¾ Export CSV
        </button>
      </div>
    </section>

    <section 
      id="progressSection" 
      class="progress-section" 
      style="display:none;" 
      role="status" 
      aria-live="polite"
    >
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div id="progressText" class="progress-text">Idle</div>
    </section>

    <section 
      id="loadingSection" 
      class="loading" 
      style="display:none;" 
      role="status" 
      aria-live="polite"
    >
      <div class="spinner" aria-hidden="true"></div>
      <p>Processing file...</p>
    </section>

    <section 
      id="errorSection" 
      class="error" 
      style="display:none;" 
      role="alert"
    ></section>

    <section 
      id="alertsSection" 
      class="alerts" 
      style="display:none;" 
      role="alert"
    ></section>

    <section 
      id="statsSection" 
      class="stats" 
      style="display:none;" 
      aria-labelledby="stats-heading"
    >
      <h2 id="stats-heading" class="sr-only">Key Statistics</h2>
    </section>

    <section 
      id="energySummary" 
      class="energy-summary" 
      style="display:none;" 
      aria-labelledby="energy-heading"
    >
      <h3 id="energy-heading" class="energy-title">âš¡ Energy Summary</h3>
      <div id="energyGrid" class="energy-grid"></div>
    </section>

    <!-- Runtime & Cost Summary Section -->
    <section 
      id="runtimeCostSummary" 
      class="stats" 
      style="display:none;" 
      aria-labelledby="runtime-heading"
    >
      <h3 id="runtime-heading" class="sr-only">Runtime & Cost Summary</h3>
    </section>

    <!-- âœ… IMPROVED: Interactive Tariff Section -->
    <section 
      id="tariffPresets" 
      class="threshold-controls" 
      style="display:none;"
      aria-labelledby="tariff-heading"
    >
      <h3 id="tariff-heading" class="energy-title">ğŸ’° Energy Cost Calculator</h3>

      <!-- Quick Preset Buttons -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: rgba(255,255,255,0.9);">
          Quick Presets:
        </label>
        <div class="controls" style="gap: 8px;">
          <button class="control-btn" onclick="setTariff(6)" title="Indian Tariff â‚¹6">â‚¹6</button>
          <button class="control-btn" onclick="setTariff(8)" title="Indian Tariff â‚¹8">â‚¹8</button>
          <button class="control-btn" onclick="setTariff(12)" title="Indian Tariff â‚¹12">â‚¹12</button>
          <button class="control-btn" onclick="setTariff(0.12)" title="US Tariff $0.12">$0.12</button>
          <button class="control-btn" onclick="setTariff(0.20)" title="EU Tariff â‚¬0.20">â‚¬0.20</button>
          <button class="control-btn" onclick="setTariff(0.30)" title="UK Tariff Â£0.30">Â£0.30</button>
        </div>
      </div>

      <!-- Custom Input Field -->
      <div class="threshold-row" style="align-items: center; gap: 10px;">
        <label for="customTariffInput" class="threshold-label" style="min-width: 150px;">
          Custom Rate (per kWh):
        </label>
        <input 
          id="customTariffInput" 
          class="threshold-input" 
          type="number" 
          step="0.01" 
          min="0"
          placeholder="Enter cost"
          aria-label="Custom tariff rate per kWh"
          style="width: 150px;"
        />
        <button 
          id="applyCustomTariffBtn" 
          class="btn" 
          onclick="applyCustomTariff()"
          title="Apply custom tariff rate"
        >
          Apply Custom Rate
        </button>
      </div>

      <!-- Current Rate Display -->
      <div style="margin-top: 15px; padding: 12px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; text-align: center;">
        <span style="color: rgba(255,255,255,0.8); font-size: 0.9em;">Current Rate:</span>
        <span id="currentTariffDisplay" style="color: #fff; font-weight: 700; font-size: 1.2em; margin-left: 8px;">0.00 / kWh</span>
      </div>
    </section>

    <section 
      id="thresholdControls" 
      class="threshold-controls" 
      style="display:none;" 
      aria-labelledby="threshold-heading"
    >
      <h3 id="threshold-heading" class="sr-only">Alert Thresholds</h3>
      
      <div class="threshold-row">
        <label for="thVoltageLow" class="threshold-label">Voltage Low (V)</label>
        <input 
          id="thVoltageLow" 
          class="threshold-input" 
          type="number" 
          step="0.1" 
          min="0"
          aria-label="Minimum voltage threshold"
        />
      </div>
      
      <div class="threshold-row">
        <label for="thVoltageHigh" class="threshold-label">Voltage High (V)</label>
        <input 
          id="thVoltageHigh" 
          class="threshold-input" 
          type="number" 
          step="0.1" 
          min="0"
          aria-label="Maximum voltage threshold"
        />
      </div>
      
      <div class="threshold-row">
        <label for="thCurrentMax" class="threshold-label">Current Max (A)</label>
        <input 
          id="thCurrentMax" 
          class="threshold-input" 
          type="number" 
          step="0.1" 
          min="0"
          aria-label="Maximum current threshold"
        />
      </div>
      
      <div class="threshold-row">
        <label for="thSocLow" class="threshold-label">SOC Low (%)</label>
        <input 
          id="thSocLow" 
          class="threshold-input" 
          type="number" 
          step="1" 
          min="0" 
          max="100"
          aria-label="Minimum state of charge threshold"
        />
      </div>

      <button id="updateThresholdsBtn" class="btn" style="margin-top: 15px;">
        Update Thresholds
      </button>
    </section>

    <section 
      id="chartsSection" 
      class="charts-section" 
      style="display:none;" 
      aria-labelledby="charts-heading"
    >
      <h2 id="charts-heading" class="sr-only">Data Visualization Charts</h2>
      
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ“Š Voltage Over Time</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('voltage')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('voltage')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="voltageChart" role="img" aria-label="Voltage over time chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">âš¡ Current Over Time</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('current')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('current')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="currentChart" role="img" aria-label="Current over time chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ”‹ State of Charge</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('soc')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('soc')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="socChart" role="img" aria-label="State of charge chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">âš™ï¸ Power Consumption</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('power')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('power')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="powerChart" role="img" aria-label="Power consumption chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ“ˆ Cumulative Energy</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('energy')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('energy')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="energyChart" role="img" aria-label="Cumulative energy chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ’° Hourly Cost Breakdown</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('hourlyCost')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('hourlyCost')">ğŸ“¥ Download</button>
          </div>
        </div>
        <div class="zoom-info" style="margin-bottom: 10px;">
          ğŸ’¡ Tip: Set a tariff rate above to see cost calculations
        </div>
        <canvas id="hourlyCostChart" role="img" aria-label="Hourly cost chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ”‹ Remaining Capacity (Ah)</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('remainingAh')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('remainingAh')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="remainingAhChart" role="img" aria-label="Remaining capacity chart"></canvas>
      </div>
    </section>

    <section 
      id="cellChartsSection" 
      class="charts-section" 
      style="display:none;" 
      aria-labelledby="cell-charts-heading"
    >
      <h2 id="cell-charts-heading" class="section-heading">ğŸ”¬ Cell-Level Analysis (16 Cells + 5 Sensors)</h2>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ“Š Cell Voltage Distribution (Latest)</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="downloadChart('cellVoltage')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="cellVoltageChart" role="img" aria-label="Cell voltage distribution chart"></canvas>
        <div class="cell-info">
          <span class="cell-count" id="cellCount">16 cells detected</span>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ“ˆ Per-Cell Voltage Trends (All 16 Cells)</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('cellVoltageTrend')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('cellVoltageTrend')">ğŸ“¥ Download</button>
          </div>
        </div>
        <div class="zoom-info">
          ğŸ–±ï¸ Scroll to zoom â€¢ Ctrl+Drag to pan
        </div>
        <canvas id="cellVoltageTrendChart" role="img" aria-label="Per-cell voltage trends chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">âš ï¸ Cell Voltage Imbalance</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('cellImbalance')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('cellImbalance')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="cellImbalanceChart" role="img" aria-label="Cell imbalance chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸŒ¡ï¸ Temperature Trends (5 Sensors)</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('cellTempTrend')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('cellTempTrend')">ğŸ“¥ Download</button>
          </div>
        </div>
        <div class="zoom-info">
          ğŸ–±ï¸ Scroll to zoom â€¢ Ctrl+Drag to pan
        </div>
        <canvas id="cellTempTrendChart" role="img" aria-label="Temperature trends chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">ğŸ”Œ FET Status</h3>
          <div class="chart-controls">
            <button class="chart-btn secondary" onclick="resetZoom('fetStatus')">ğŸ” Reset Zoom</button>
            <button class="chart-btn secondary" onclick="downloadChart('fetStatus')">ğŸ“¥ Download</button>
          </div>
        </div>
        <canvas id="fetStatusChart" role="img" aria-label="FET status chart"></canvas>
      </div>
    </section>

    <footer class="export-section">
      <p>
        Built with â¤ï¸ for BMS Analysis â€¢ 
        <a href="https://github.com/krishnavamsi333/BMS" target="_blank" rel="noopener noreferrer">
          View on GitHub
        </a>
      </p>
    </footer>
  </div>

  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    
    .section-heading {
      font-size: 1.5em;
      font-weight: 600;
      color: rgb(255, 255, 255);
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
  </style>
</body>
</html>