<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BMS Log Visualizer</title>

    <meta
      name="description"
      content="Upload your BMS YAML logs and visualize voltage, current, SOC and energy consumption with interactive charts."
    />

    <!-- Main styles -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/responsive.css" />

    <!-- Libraries -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
      defer
    ></script>

    <!-- Your app scripts (order matters) -->
    <script src="js/config.js" defer></script>
    <script src="js/utils.js" defer></script>
    <script src="js/parser.js" defer></script>
    <script src="js/calculations.js" defer></script>
    <script src="js/charts.js" defer></script>
    <script src="js/app.js" defer></script>
  </head>

  <body>
    <a class="skip-to-content" href="#main">Skip to main content</a>

    <div class="container" id="main" role="main">
      <header class="header">
        <h1>BMS Log Visualizer</h1>
        <div class="subtitle">Upload ROS2-style YAML logs and explore battery metrics.</div>
      </header>

      <section class="upload-section" aria-labelledby="uploadLabel">
        <div class="file-input-wrapper">
          <input id="fileInput" type="file" accept=".yaml,.yml,.txt" />
          <label for="fileInput" class="file-label" id="uploadLabel">Choose file</label>
        </div>
        <div id="fileName" class="file-name">No file selected</div>

        <div class="controls" role="toolbar" aria-label="Visualization controls">
          <button id="absoluteTimeBtn" class="control-btn active" aria-pressed="true">Absolute Time</button>
          <button id="relativeTimeBtn" class="control-btn" aria-pressed="false">Relative Time</button>
          <button id="smoothingBtn" class="control-btn" aria-pressed="false">Smoothing: Off</button>
          <button id="clearBtn" class="control-btn">Clear</button>
          <button id="exportBtn" class="control-btn">Export CSV</button>
          <button id="exportFullBtn" class="control-btn">Export Full</button>
        </div>
      </section>

      <section id="progressSection" class="progress-section" style="display:none;">
        <div class="progress-bar" aria-hidden="true">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" class="progress-text">Idle</div>
      </section>

      <section id="loadingSection" class="loading" style="display:none;" aria-live="polite">
        <div class="spinner" role="status" aria-hidden="true"></div>
        <div>Processing file…</div>
      </section>

      <section id="errorSection" class="error" style="display:none;" role="alert" aria-live="assertive"></section>

      <section id="alertsSection" class="alerts" style="display:none;" aria-live="polite"></section>

      <section id="statsSection" class="stats" style="display:none;" aria-label="Summary statistics"></section>

      <section id="energySummary" class="energy-summary" style="display:none;">
        <div class="energy-title">Energy Summary</div>
        <div id="energyGrid" class="energy-grid"></div>
      </section>

      <section id="thresholdControls" class="threshold-controls" style="display:none;" aria-label="Threshold controls">
        <div class="threshold-row">
          <label class="threshold-label" for="thVoltageLow">Voltage low (V)</label>
          <input id="thVoltageLow" class="threshold-input" type="number" step="0.1" />

          <label class="threshold-label" for="thVoltageHigh">Voltage high (V)</label>
          <input id="thVoltageHigh" class="threshold-input" type="number" step="0.1" />
        </div>
        <div class="threshold-row">
          <label class="threshold-label" for="thCurrentMax">Current max (A)</label>
          <input id="thCurrentMax" class="threshold-input" type="number" step="0.1" />

          <label class="threshold-label" for="thSocLow">SOC low (%)</label>
          <input id="thSocLow" class="threshold-input" type="number" step="0.1" />

          <button id="updateThresholdsBtn" class="control-btn">Update</button>
        </div>
      </section>

      <section id="chartsSection" class="charts-section" style="display:none;" aria-label="Charts">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Voltage</div>
            <div class="chart-controls">
              <button class="chart-btn secondary" type="button" onclick="resetZoom('voltage')">Reset Zoom</button>
              <button class="chart-btn" type="button" onclick="downloadChart('voltage')">Download</button>
            </div>
          </div>
          <canvas id="voltageChart" aria-label="Voltage chart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Current</div>
            <div class="chart-controls">
              <button class="chart-btn secondary" type="button" onclick="resetZoom('current')">Reset Zoom</button>
              <button class="chart-btn" type="button" onclick="downloadChart('current')">Download</button>
            </div>
          </div>
          <canvas id="currentChart" aria-label="Current chart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">State of Charge (SOC)</div>
            <div class="chart-controls">
              <button class="chart-btn secondary" type="button" onclick="resetZoom('soc')">Reset Zoom</button>
              <button class="chart-btn" type="button" onclick="downloadChart('soc')">Download</button>
            </div>
          </div>
          <canvas id="socChart" aria-label="SOC chart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Power</div>
            <div class="chart-controls">
              <button class="chart-btn secondary" type="button" onclick="resetZoom('power')">Reset Zoom</button>
              <button class="chart-btn" type="button" onclick="downloadChart('power')">Download</button>
            </div>
          </div>
          <canvas id="powerChart" aria-label="Power chart"></canvas>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Cumulative Energy</div>
            <div class="chart-controls">
              <button class="chart-btn secondary" type="button" onclick="resetZoom('energy')">Reset Zoom</button>
              <button class="chart-btn" type="button" onclick="downloadChart('energy')">Download</button>
            </div>
          </div>
          <canvas id="energyChart" aria-label="Energy chart"></canvas>
        </div>
      </section>

      <footer class="export-section">
        <div>Built with ❤️ — <a href="https://github.com/krishnavamsi333/BMS" target="_blank" rel="noopener">Project on GitHub</a></div>
      </footer>
    </div>

    <script>
      // Small enhancement: update file name when user picks a file via keyboard or drag
      document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('fileInput');
        const label = document.querySelector('.file-label');
        if (input && label) {
          label.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              input.click();
            }
          });
        }
      });
    </script>
  </body>
</html>
